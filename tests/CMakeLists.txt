CMAKE_MINIMUM_REQUIRED(VERSION 3.10)
PROJECT(Tests)

LOAD_OPENCV()

SET(DEPENDENCY_INCLUDES
    ${OpenCV_INCLUDE_DIRS}
    ${PROJECT_INCLUDE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/../src/ort
    ${CMAKE_CURRENT_SOURCE_DIR}/../src/ncnn
)

SET(DEPENDENCY_LIBS
    ai_core::ai_core
    common_utils::common_utils
    logger::logger
    encrypt::encrypt
    ${OpenCV_LIBS}
    GTest::gtest
    GTest::gtest_main
)

IF(WITH_ORT_ENGINE)
	LOAD_ONNXRUNTIME()
	LIST(APPEND DEPENDENCY_INCLUDES  
		${ONNXRUNTIME_INCLUDE_DIR}
    	${ONNXRUNTIME_INCLUDE_DIR}/onnxruntime
	)
	LIST(APPEND DEPENDENCY_LIBS ${ONNXRUNTIME_LIBS})
	ADD_DEFINITIONS(-DWITH_ORT)
ENDIF()

IF(WITH_NCNN_ENGINE)
	LOAD_OPENMP()
	LOAD_NCNN()

	LIST(APPEND DEPENDENCY_INCLUDES  
		${NCNN_INCLUDE_DIR}
	)
	LIST(APPEND DEPENDENCY_LIBS ${NCNN_LIBS} ${OpenMP_CXX_FLAGS})
	ADD_DEFINITIONS(-DWITH_NCNN)
ENDIF()

FILE(GLOB CURRENT_DIR_SRCS ${CMAKE_CURRENT_SOURCE_DIR}/*.cpp ${CMAKE_CURRENT_SOURCE_DIR}/*.cc)

MESSAGE(STATUS "APP SOURCES: ${CURRENT_DIR_SRCS}")

FILE(MAKE_DIRECTORY ${PROJECT_OUTPUT_DIR}/bin/tests)
SET(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${PROJECT_OUTPUT_DIR}/bin/tests)

# Copy the conf directory to the runtime output directory for tests
IF(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/conf")
    MESSAGE(STATUS "Copying test config directory: ${CMAKE_CURRENT_SOURCE_DIR}/conf to ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/conf")
    FILE(COPY "${CMAKE_CURRENT_SOURCE_DIR}/conf/" DESTINATION "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/")
ENDIF()

ADD_EXECUTABLE(ai_core_tests ${CURRENT_DIR_SRCS})
TARGET_INCLUDE_DIRECTORIES(ai_core_tests PRIVATE ${DEPENDENCY_INCLUDES})
TARGET_LINK_LIBRARIES(ai_core_tests PRIVATE ${DEPENDENCY_LIBS})
INSTALL(TARGETS ai_core_tests DESTINATION tests)

IF(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/data")
    INSTALL(DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/data" DESTINATION .)
ENDIF()

IF(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/conf")
    INSTALL(DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/conf" DESTINATION .)
ENDIF()

IF(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/models")
    INSTALL(DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/models" DESTINATION .)
ENDIF()
